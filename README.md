# Stripes CLI

Copyright (C) 2017-2018 The Open Library Foundation

This software is distributed under the terms of the Apache License,
Version 2.0. See the file "[LICENSE](LICENSE)" for more information.

## Introduction

Stripes CLI is a command line interface to facilitate the creation, development, building, and testing of Stripes UI modules.

* [Installation](#installation)
* [Running Stripes-CLI](#running-stripes-cli)
* [Available commands](#available-commands)
    * [`new` command](#new-command)
    * [`app` command](#app-command)
    * [`serve` command](#serve-command)
    * [`build` command](#build-command)
    * [`test` command (work in progress)](#test-command-work-in-progress)
    * [`alias` command](#alias-command)
    * [`status` command](#status-command)
* [Available Okapi Commands](#available-okapi-commands)
    * [`okapi` command](#okapi-command)
    * [`mod` command (work in progress)](#mod-command-work-in-progress)
    * [`perm` command (work in progress)](#perm-command-work-in-progress)
* [Stripes CLI Configuration](#stripes-cli-configuration)
* [Environment Variables](#environment-variables)
* [Note about context](#note-about-context)
* [Note about platforms](#note-about-platforms)

## Installation

Stripes CLI is currently not published to `npm-folio`.  This will change once it becomes more stable.  To install the CLI now, use the `npm-folioci` registry.
```
yarn config set @folio:registry https://repository.folio.org/repository/npm-folioci/
yarn global add @folio/stripes-cli
```

To develop the CLI:
1. Clone this repo
1. From the `stripes-cli` directory, run: `npm install -g`

## Running Stripes-CLI

Stripes CLI is invoked using `stripes`.  Note: stripes-core also has some commands invoked by `stripes` (`dev` and `serve`).  The CLI is meant to be a replacement for these.

Note: When serving or building an existing app module that has dependencies on unreleased versions of other Stripes modules, be sure to use the `npm-folioci` registry.

## Available commands

Run each command with `--help` to view all available options and more examples.

```
stripes build --help
```

### `new` command

Alias for various `create` sub-commands.  See `app create`.

Example:
```
stripes new app "Hello World" --install
```

### `app` command

Manage Stripes UI app modules with the `app` command and sub-commands.

The `create` sub-command creates a new Stripes UI module, directory, and optionally yarn install its dependencies.

Example:
```
stripes app create "Hello World" --install
```

The skeleton module generated by `app create` can be served up right away, but will require the appropriate permissions applied to Okapi (see [adding permissions](https://github.com/folio-org/stripes-core/blob/master/doc/adding-permissions.md)). Given you have previously logged into an Okapi instance using the `okapi login` command, the following `app create` options can automate the process in a single step:

* `--push` Push the app's module descriptor to Okapi and enable it for the current tenant (as defined by `--tenant`).
* `--assign [username]` Assign the app's default permissions to a user.

Example:
```
stripes app create "Hello World" --install --push --assign someone
```

### `serve` command

Build Stripes tenant bundle and launch a development web server. Given a file argument like `stripes.config.js`, `serve` will operate much like the `dev` command does today in stripes-core.

In an APP context, `serve` will generate a virtual platform containing just the current app module.  This is most useful for developing a new ui-app in isolation within its own virtual platform as there is no need to clone or link supporting repositories.

In order to view and log into the platform being served up, a suitable Okapi backend will need to be running. The [FOLIO testing-backend](https://app.vagrantup.com/folio/boxes/testing-backend) Vagrant box should work when serving up a newly created app that does not yet have its own backend module.

Note: When serving up a newly created app that does not have its own backend permissions established, pass the `--hasAllPerms` option to display the app in the UI navigation.

Example:
```
stripes serve --port=8080 --hasAllPerms
```


### `build` command

Build a Stripes tenant bundle and save build artifacts to a directory.  Given a file argument like `stripes.config.js`, `build` will operate much like `build` does today in stripes-core.  However, stripes-cli will now generate a config when the file is omitted (APP context).

The output directory can now be supplied as an option `--output`.  This differs from stripes-core's `build` command which only used a positional argument.  This was done to accommodate building of virtual platforms which do not require passing a stripes configuration file.

Example:
```
stripes build stripes.config.js ./path/to/directory
```

Note: Builds intended for production should be made using a previously defined platform with its own yarn installed dependencies, including stripes-core, no yarn linking, and no aliases set in the CLI.


### `test` command (work in progress)

Runs tests for an app in the APP context.

The `nightmare` sub-command supports UI integration tests written for NightmareJS.  The tests support a small subset of the options available in [ui-testing](https://github.com/folio-org/ui-testing).  This includes `--run`, `--host`, and `--port`.  Note: The `--run` option varies slightly from ui-testing in that it should be supplied with only a test script name (`--run=<script>`) and not include the app name as it does today (`--run=<app:script>`).

Example:
```
stripes test nightmare --run=demo --show
```

The `karma` sub-command supports running an app's tests with Karma.  These tests currently depend on the app's own infrastructure to define the test harness that loads the app (work in progress).  The CLI will generate a webpack configuration for Karma similar to `build` and `serve` so no mocking of `stripes-config` is necessary.

Example:
```
stripes test karma
```

### `alias` command

Create and persists Webpack resolve aliases for use when building a platform. Sub-commands include `add`, `remove`, `list`, and `clear`.  These are applied automatically to builds in both app and platform contexts.

Example:
```
stripes alias add @folio/users ../path/to/ui-users
```

Aliases can also be defined in a [.stripesclirc file](#stripes-cli-configuration).  This is particularly useful if you have a group of Stripes UI apps that you develop locally with and prefer not to enter them individually on the command line.

Note:  UI module aliases should not be used in production builds.  As with Yarn linking, a module aliased to a separately Yarn installed repository will have no overlap for common dependencies, resulting in a larger bundle.


### `status` command

Display information about the CLI, including the inferred context which it is running.  The status output also includes the Stripes config JSON used when generating a virtual platform in the current context.  Any aliases that have been set are also noted.

Example:
```
stripes status
```

## Available Okapi Commands

The following commands primarily interact with Okapi.  When working with Okapi, it easiest to set `okapi` and `tenant` options in a [.stripesclirc file](#stripes-cli-configuration) or [environment variables](#environment-variables).  Either method avoids the need  to manually supply `--okapi` and `--tenant` with each command.

### `okapi` command

Log into an Okapi instance and persist the token.

Example:
```
stripes okapi login myusername
```

### `mod` command (work in progress)

Manage UI modules in Okapi. At the moment support is limited to the UI module present in the current working directory (APP context).

Sub-commands `add`, `remove`, and `update` will operate on the current Stripes UI app's module descriptor in Okapi.  When issuing an update on an existing module descriptor, the CLI will attempt to remove it first.

Example:
```
stripes mod add
```

Sub-commands `enable` and `disable` will enable or disable the Stripes UI app module for a tenant specified with `--tenant`.

Example:
```
stripes mod enable
```


### `perm` command (work in progress)

Manage UI module permissions.  Sub-commands include `create` and `assign`.  When creating a new permission, the `--push` option will attempt to update the module descriptor in Okapi and optionally assign the newly created permission to a user.

Example:
```
stripes perm create ui-hello-world.example --desc "An example permission" --push --assign someone
```

## Stripes CLI Configuration

Frequently used options can be saved to a `.stripesclirc` file to avoid entering them each time.  Stripes CLI will use the configuration file found in the current working directory, or the first one walking up the tree.

Any supported command-line positional or option can be defined.  For example:
```
{
  "configFile": "stripes.config.js",
  "port": 8080
}
```

Aliases for Stripes UI apps are also supported.  Aliases paths should be relative to the directory containing the `.stripesclirc` config file which defines the aliases.
```
{
  "aliases": {
    "@folio/users": "../ui-users"
  }
}
```

## Environment Variables

CLI options can be set using environment variables prefixed with `STRIPES_`.  For example, to specify the `--port` option using an environment variable, use `STRIPES_PORT=8080`.

## Note about context

Certain CLI operations will vary depending on the context in which the command was run.  Stripes CLI will attempt to infer the context.  Contexts include:

- APP:  Used when a package.json containing `stripes` is present.  Context actually matches the `stripes.type` property, but only "app" is currently supported.
- PLATFORM: Used when a package.json containing one or more `@folio/` dependencies is found, but no `stripes` object.
- EMPTY:  No package.json detected.  Suitable for creating new UI modules

Use the `status` command to view the current context.

## Note about platforms

Stripes UI modules are meant to be built together with other modules in a platform that shares common build infrastructure.  A platform consists of a `package.json` and a tenant configuration typically named `stripes.config.js`. See the [Stripes Sample Platform](https://github.com/folio-org/stripes-sample-platform) for a good example.

The platform that Stripes CLI uses is constructed in the following order:

1. Base configuration:  When a file argument like `stripes.config.js` is provided, this will be used as the base.  Otherwise, the CLI will use its own internal defaults that contain no modules.

2. Virtual configuration:  In the APP context, the CLI will apply the current app as a module and generate an alias for the app to be run in isolation.  In the PLATFORM or APP context, the CLI will then add modules for all aliases defined, but only when an explicit module configuration is absent from `stripes.config.js`, or no `stripes.config.js` has been provided.

3. Command configuration: Any relevant options passed in on the command line are applied to the configuration last.

Tip: Use the `status` command (optionally with a file and/or other config options) to view the CLI's generated platform configuration in the current context.
